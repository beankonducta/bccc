<html>

<head>
  <link rel="stylesheet" href="players.css">
  <link rel="stylesheet" href="https://use.typekit.net/vlj7tzj.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Blue Copper Chess Club</title>
  <link rel="icon" type="image/x-icon" href="Images/favicon.png">
  <meta property="og:image" content="Images/social.png">
  <meta property="og:image:type" content="image/png">
</head>

<body>

  <audio id="yourTurn">
    <source src="Images/yourTurn.mp3" type="audio/mpeg">
  </audio>

  <script>

    // audio
    var x = document.getElementById("yourTurn");

    function playAudio() {
      x.play();
    }

    var games = [
      // 4.28
      "CB beats TD",
      "EC beats PA",
      "CB beats TD",
      // 5.5
      "EC beats HP",
      "CB beats SD",
      "JG beats MM",
      "JG beats PA",
      "MM beats HP",
      "DV beats TD",
      "TD beats JG",
      "CB beats EC",
      "EC beats CB",
      "JG beats EC",
      "TD beats CB",
      // 5.12
      "CB beats DV",
      "TD beats MM",
      "JG beats HP",
      "CB beats MM",
      "CB beats JG",
      "JG beats HP",
      "CB beats HP",
      // 5.19
      "JG beats HP",
      "TD beats CB",
      "EC beats CB",
      "JG beats TD",
      "HP draws OR",
      "JG beats CB",
      // 5.26
      "TD beats JG",
      "HP beats DV",
      "PA draws CB",
      "JG beats DV",
      "PA beats DV",
      "CB beats JG",
      "TD beats HP",
      // 6.2
      "EC beats JG",
      "EC beats JG",
      "PA beats HP",
      "EC beats DV",
      "TD beats SD",
      "EC beats DV",
      "LX beats CB",
      "LX beats EC",
      "MR beats JG",
      "JG beats MR",
      "CB beats DV",
      "JG beats HP",
      "DV beats MR",
      "CC beats CB",
      "TD beats PA",
      "MR beats JI",
      "DV beats HP",
      // 6.9
    ];

    // array of players, could easily be a database
    var players = [
      { name: "Carter B.", initials: "CB", irl_mmr: "1200", web_mmr: "Loading..", win: 0, loss: 0, tie: 0, li_profile: "caboyd", com_profile: "", handle: "caboyd", display: true },
      { name: "Jackson G.", initials: "JG", irl_mmr: "1200", web_mmr: "Loading..", win: 0, loss: 0, tie: 0, li_profile: "grassleaf", com_profile: "jacksongraessle", handle: "grassleaf", display: true },
      { name: "Eric C.", initials: "EC", irl_mmr: "1200", web_mmr: "Loading..", win: 0, loss: 0, tie: 0, li_profile: "", com_profile: "", handle: "ericc", display: true },
      { name: "Drew V.", initials: "DV", irl_mmr: "1200", web_mmr: "Loading..", win: 0, loss: 0, tie: 0, li_profile: "", com_profile: "", handle: "drewv", display: true },
      { name: "Tyler D.", initials: "TD", irl_mmr: "1200", web_mmr: "Loading..", win: 0, loss: 0, tie: 0, li_profile: "", com_profile: "", handle: "tylerd", display: true },
      { name: "Matt M.", initials: "MM", irl_mmr: "1200", web_mmr: "Loading..", win: 0, loss: 0, tie: 0, li_profile: "", com_profile: "", handle: "mattm", display: true },
      { name: "Patrick A.", initials: "PA", irl_mmr: "1200", web_mmr: "Loading..", win: 0, loss: 0, tie: 0, li_profile: "", com_profile: "bnkndcta", handle: "bnkndcta", display: true },
      { name: "Harrison P.", initials: "HP", irl_mmr: "1200", web_mmr: "Loading..", win: 0, loss: 0, tie: 0, li_profile: "", com_profile: "", handle: "harrisonp", display: true },
      { name: "SD", initials: "SD", irl_mmr: "1200", web_mmr: "Loading..", win: 0, loss: 0, tie: 0, li_profile: "", com_profile: "", handle: "SD", display: false },
      { name: "MM", initials: "MM", irl_mmr: "1200", web_mmr: "Loading..", win: 0, loss: 0, tie: 0, li_profile: "", com_profile: "", handle: "MM", display: false }
    ];

    function buildProfileText(player) {
      if (player.li_profile !== "" && player.com_profile !== "")
        return `<td><a href="https://lichess.org/@/${player.li_profile}">Lichess</a> / <a href="https://chess.com/member/${player.com_profile}">Chess.com</a></td>`;
      else if (player.li_profile !== "")
        return `<td><a href="https://lichess.org/@/${player.li_profile}">Lichess</a></td>`;
      else if (player.com_profile !== "")
        return `<td><a href="https://chess.com/member/${player.com_profile}">Chess.com</a></td>`;
      else return `<td>...</td>`;
    }

    function sortPlayers() {
      players.sort((a, b) => {
        if (a.irl_mmr > b.irl_mmr) return -1;
        if (b.irl_mmr > a.irl_mmr) return 1;
        return 0;
      });
    }

    function lichessCall(player) {
      fetch(`https://lichess.org/api/user/${player.li_profile}`)
        .then((r) => r.json())
        .then((data) => {
          document.getElementById(player.handle).innerHTML = data.perfs.classical.rating;
        })
        .catch((e) => document.getElementById(player.handle).innerHTML = "...");
    }

    function chessDotComCall(player) {
      fetch(`https://api.chess.com/pub/player/${player.com_profile}/stats`)
        .then((r) => r.json())
        .then((data) => {
          document.getElementById(player.handle).innerHTML = data.chess_rapid.last.rating;
        })
        .catch((e) => document.getElementById(player.handle).innerHTML = "...");
    }

    function addRow(player) {
      var newRow = document.getElementById('player-table').insertRow();
      newRow.innerHTML = `
            <td>${player.name}</td>
            <td>${player.irl_mmr}</td>
            <td id="${player.handle}">${player.web_mmr}</td>
            <td>${player.win}/${player.loss}/${player.tie}</td>
            ${buildProfileText(player)}
        `;
    }

    // https://github.com/moroshko/elo.js/blob/master/elo.js
    function getRatingDelta(myRating, opponentRating, myGameResult) {
      if ([0, 0.5, 1].indexOf(myGameResult) === -1) {
        return null;
      }
      var myChanceToWin = 1 / (1 + Math.pow(10, (opponentRating - myRating) / 400));
      return Math.round(32 * (myGameResult - myChanceToWin));
    }
    // 0 is loss, .5 is tie, 1 is win
    function getNewRating(myRating, opponentRating, myGameResult) {
      return myRating + getRatingDelta(myRating, opponentRating, myGameResult);
    }

    // TODO: refactor
    function parseGames() {
      for (let game of games) {
        var gameSplit = []; // array of split text
        var result = -1; // result of game
        if (game.includes("beats"))
          gameSplit = game.split(" beats ")
        else
          gameSplit = game.split(" draws ")
        const p1 = getPlayerByInitials(gameSplit[0]);
        const p2 = getPlayerByInitials(gameSplit[1]);
        // TODO: figure out a way to alter mmrs regardless of one player missing from array
        if (p1 !== null && p2 !== null) {
          var p1Rating = -1;
          var p2Rating = -1;
          if (game.includes("beats")) {
            p1Rating = getNewRating(+p1.irl_mmr, +p2.irl_mmr, 1);
            p2Rating = getNewRating(+p2.irl_mmr, +p1.irl_mmr, 0);
            p1.win++;
            p2.loss++;
          } else {
            p1Rating = getNewRating(+p1.irl_mmr, +p2.irl_mmr, .5);
            p2Rating = getNewRating(+p2.irl_mmr, +p1.irl_mmr, .5);
            p1.tie++;
            p2.tie++;
          }
          p1.irl_mmr = p1Rating;
          p2.irl_mmr = p2Rating;
        }
      }
    }

    // TODO: refactor
    function getPlayerByInitials(inits) {
      for (let player of players) {
        if (player.initials === inits)
          return player;
      }
      return null;
    }

    // https://stackoverflow.com/a/54437356
    function getNextDayOfTheWeek(dayName, excludeToday = true, refDate = new Date()) {
      const dayOfWeek = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"]
      .indexOf(dayName.slice(0, 3).toLowerCase());
      const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
      const fullDays =["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
      if (dayOfWeek < 0) return;
      refDate.setHours(0, 0, 0, 0);
      refDate.setDate(refDate.getDate() + +!!excludeToday +
        (dayOfWeek + 7 - refDate.getDay() - +!!excludeToday) % 7);
      return `${months[refDate.getMonth()]} ${refDate.getDate()}`;
    }

    window.addEventListener('load', () => {
      parseGames();
      sortPlayers();
      // populates the date field, switches to 'next week' if it's after noon o clock!
      document.getElementById('mobile-date').textContent = `meet this week (${getNextDayOfTheWeek("Thursday", new Date().getHours() > 12 ? true : false)})`
      document.getElementById('date').textContent = `meet this week (${getNextDayOfTheWeek("Thursday", new Date().getHours() > 12 ? true : false)})`
      players.forEach(player => {
        if (player.display) { // only render player if we have their display flag set to true
          addRow(player);
          if (player.li_profile !== "")
            lichessCall(player);
          else if (player.com_profile !== "")
            chessDotComCall(player);
          else
            chessDotComCall(player); // this will fail but add "..." to player web mmr
        }
      });
    });
  </script>

  <div class="nav">
    <ul class="nav">
      <img src="Images/webheader.png" width=100%>
      <li><a href="index.html">Information</a></li>
      <li><a href="players.html">Players</a></li>
    </ul>
    <div class="mobile">
      <h2> B.C. Chess Club
        <span class="active">will</span>
        <span class="inactive"> will not</span>
        <span id="mobile-date"></span>
      </h2>
      <p> 8 A.M. \ <a href="https://www.bluecopperslc.com/" target="_blank">Blue Copper 2000</a> \ 401 N 300 W </p>
    </div>
  </div>
  </div>

  <div class="content">

    <div class="first-column">
      <h1> Active Players:</h1>
      <p> Ratings are internal and based on in-club games. Calculations by <a
          href="http://www.qa76.net/elo">qa76.net</a>. Records display W/L/D. </p>
      <div class="table">
        <table id="player-table">
          <tr>
            <th>Player</th>
            <th>Rating [IRL]</th>
            <th>Rating [WEB]</th>
            <th>Record</th>
            <th>Profile</th>
          </tr>
        </table>
      </div>
    </div>

    <div class="second-column">
      <h1>Join Us:</h1>
      <h2> B.C. Chess Club </br>
        <span class="active">will</span> &nbsp;&nbsp;
        <span class="inactive"> will not </span></br>
        <span id="date"></span>
      </h2>
      <p>Thursday Mornings, 8 A.M.</br>
        <a href="https://www.bluecopperslc.com/" target="_blank">Blue Copper 2000 </a>
        </br>401 N 300 W
        </br> SLC, UT
      </p>
    </div>

</body>

</html>